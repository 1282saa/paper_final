service: learning-notes-api

frameworkVersion: '3'

provider:
  name: aws
  runtime: nodejs18.x
  region: us-east-1
  stage: ${opt:stage, 'dev'}
  memorySize: 1024
  timeout: 300  # 5분 (OCR, Embeddings는 시간이 걸릴 수 있음)

  # 환경변수
  environment:
    AWS_REGION: ${env:AWS_REGION}
    S3_BUCKET_NAME: ${env:S3_BUCKET_NAME}
    BEDROCK_MODEL_ID: ${env:BEDROCK_MODEL_ID}
    DYNAMODB_TABLE_NAME: ${self:custom.tableName}
    STAGE: ${self:provider.stage}

  # IAM 권한
  iam:
    role:
      statements:
        # S3 권한
        - Effect: Allow
          Action:
            - s3:PutObject
            - s3:GetObject
            - s3:DeleteObject
          Resource: "arn:aws:s3:::${env:S3_BUCKET_NAME}/*"

        # Textract 권한
        - Effect: Allow
          Action:
            - textract:DetectDocumentText
            - textract:AnalyzeDocument
          Resource: "*"

        # Bedrock 권한
        - Effect: Allow
          Action:
            - bedrock:InvokeModel
            - bedrock:InvokeModelWithResponseStream
          Resource:
            - "arn:aws:bedrock:*::foundation-model/anthropic.claude-*"
            - "arn:aws:bedrock:*::foundation-model/amazon.titan-*"

        # DynamoDB 권한
        - Effect: Allow
          Action:
            - dynamodb:PutItem
            - dynamodb:GetItem
            - dynamodb:UpdateItem
            - dynamodb:DeleteItem
            - dynamodb:Query
            - dynamodb:Scan
            - dynamodb:BatchWriteItem
            - dynamodb:BatchGetItem
          Resource:
            - !GetAtt LearningNotesTable.Arn
            - !Sub "${LearningNotesTable.Arn}/index/*"

# 커스텀 변수
custom:
  tableName: learning-notes-table-${self:provider.stage}

# 플러그인
plugins:
  - serverless-offline
  - serverless-dotenv-plugin

# 함수 정의
functions:
  # 헬스체크
  health:
    handler: lambda/health.handler
    events:
      - httpApi:
          path: /health
          method: get

  # 노트 업로드 (Pre-signed URL 생성)
  createUploadUrl:
    handler: lambda/notes/createUploadUrl.handler
    events:
      - httpApi:
          path: /notes/upload-url
          method: post
          cors: true

  # OCR 처리 (S3 트리거)
  processUpload:
    handler: lambda/notes/processUpload.handler
    events:
      - s3:
          bucket: ${env:S3_BUCKET_NAME}
          event: s3:ObjectCreated:*
          rules:
            - prefix: notes/
          existing: true

  # 노트 목록 조회
  getNotes:
    handler: lambda/notes/getNotes.handler
    events:
      - httpApi:
          path: /notes
          method: get
          cors: true

  # 노트 상세 조회
  getNote:
    handler: lambda/notes/getNote.handler
    events:
      - httpApi:
          path: /notes/{noteId}
          method: get
          cors: true

  # 노트 인덱싱 (벡터화)
  indexNote:
    handler: lambda/rag/indexNote.handler
    timeout: 600  # 10분 (많은 청크 처리 시)
    events:
      - httpApi:
          path: /rag/index-note
          method: post
          cors: true

  # RAG 질의응답
  ragAsk:
    handler: lambda/rag/ask.handler
    events:
      - httpApi:
          path: /rag/ask
          method: post
          cors: true

  # 문제 생성
  generateQuestions:
    handler: lambda/questions/generate.handler
    timeout: 600  # 10분
    events:
      - httpApi:
          path: /questions/generate
          method: post
          cors: true

  # 문제 조회
  getQuestions:
    handler: lambda/questions/getQuestions.handler
    events:
      - httpApi:
          path: /questions
          method: get
          cors: true

  # 채팅 (일반)
  chatAsk:
    handler: lambda/chat/ask.handler
    events:
      - httpApi:
          path: /chat/ask
          method: post
          cors: true

  # AI 튜터
  chatTutor:
    handler: lambda/chat/tutor.handler
    events:
      - httpApi:
          path: /chat/tutor
          method: post
          cors: true

# 커스텀 리소스
resources:
  Resources:
    # DynamoDB 테이블
    LearningNotesTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.tableName}
        BillingMode: PAY_PER_REQUEST  # On-Demand (자동 스케일링)
        AttributeDefinitions:
          # Primary Key
          - AttributeName: PK
            AttributeType: S
          - AttributeName: SK
            AttributeType: S
          # GSI1 (과목별, 사용자별 문제 조회)
          - AttributeName: GSI1PK
            AttributeType: S
          - AttributeName: GSI1SK
            AttributeType: S
        KeySchema:
          - AttributeName: PK
            KeyType: HASH
          - AttributeName: SK
            KeyType: RANGE
        GlobalSecondaryIndexes:
          # GSI1: 과목별 조회, 사용자별 문제 조회
          - IndexName: GSI1
            KeySchema:
              - AttributeName: GSI1PK
                KeyType: HASH
              - AttributeName: GSI1SK
                KeyType: RANGE
            Projection:
              ProjectionType: ALL  # 모든 속성 프로젝션
        StreamSpecification:
          StreamViewType: NEW_AND_OLD_IMAGES  # DynamoDB Streams (선택사항)
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true  # 백업 활성화
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}
          - Key: Project
            Value: LearningNotes

    # S3 버킷 (이미 존재하면 주석 처리)
    # NotesBucket:
    #   Type: AWS::S3::Bucket
    #   Properties:
    #     BucketName: ${env:S3_BUCKET_NAME}
    #     CorsConfiguration:
    #       CorsRules:
    #         - AllowedHeaders: ['*']
    #           AllowedMethods: [GET, PUT, POST, DELETE]
    #           AllowedOrigins: ['*']
    #           MaxAge: 3000

# 패키지 설정
package:
  patterns:
    - '!.git/**'
    - '!.vscode/**'
    - '!test/**'
    - '!*.md'
    - '!.env.example'
